---
title: "Process_GrowthRateData"
author:
- Sylwia Sliwinska-Wilczewska
- Douglas A. Campbell
date: "`r format(Sys.Date())`"
output:
bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
bibliography: BalticPhotoperiod.bib
csl: plos-one.csl
editor_options: 
  markdown: 
    wrap: 72
---

# Set Chunk Options

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

# Introduction

Process_GrowthRateData.Rmd processes and combines PICO_Cleaned_MCData.Rds from Data/CleanedData/CleanedMCData folder and both BalticPhotoperiod_Processed_PigmentsAll.Rds and BalticPhotoperiod_Processed_PigmentsExp.Rds from Data/ProcessedData/ProcessedPigmentsData. This .Rmd generates BalticPhotoperiod_Processed_GrowthRateAll.Rds (stored in Data/ProcessedData/ProcessesGrowthRateData folder) and 2 plots (stored in Output/Figures folder).

# Load Libraries and set Project Variables

```{r load libraries} 
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(strucchange)
library(ggpubr)
library(caret)
library(reshape2)
library(gcookbook)
library(ggspectra)
library(photobiologyWavebands)
library(photobiology)
library(scales)
library(minpack.lm) #Standard 'nls' framework that uses 'nls.lm' for fitting
library(data.table)
library(googledrive)
library(googlesheets4)
library(tidyverse)
#library("grid")
library(Cairo) #for greek symbols
library("patchwork") # merging plots

```

```{r set project variables}
Project <- "BalticO2"
DataOut <- file.path("..", "Data", "ProcessedData", "ProcessedGrowthRateData")
DataIn <- file.path("..", "Data", "CleanedData", "CleanedMCData", fsep = .Platform$file.sep)

FigPath <- file.path("..", "Output", "Figures")
FigRdsPath <- file.path("..", "Output", "FiguresRds")
TableRdsPath <- file.path("..", "Output", "TablesRDS")

FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```

# List and read files

```{r Exported Rmd only first time in session}
list.files(path = DataIn, full.names = TRUE)
```

```{r read file}
MultiCultiGrowthFile <- "../Data/CleanedData/CleanedMCData/PICO_Cleaned_MCData.Rds"

MultiCultiGrowthFileName <- str_split(string = MultiCultiGrowthFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 

MultiCultiGrowth <- readRDS(MultiCultiGrowthFile)  %>%
  ungroup()
```

# Select revelant variables and preparing for further analysis

```{r}
MultiCultiGrowth<-MultiCultiGrowth %>% 
  dplyr::select(c(Tube, ExpDate, MC, Run, SampleID, Strain, Par_ue, Photoperiod, WL, O2, LightShape, PARPhotonDose_day, OD720_Lmu_se, OD720_Lmu_corr, deltaOD_Lmu_se, deltaOD_Lmu_corr))
  
MultiCultiGrowth<-MultiCultiGrowth %>% 
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich",
         Strain=="BA77G"~"PC-rich"))

```


# Growth rate per day

```{r}
MultiCultiGrowth<-MultiCultiGrowth %>% 
  mutate(OD720_Lmu_corr = OD720_Lmu_corr*24) %>% 
  mutate(OD720_Lmu_se = OD720_Lmu_se*24) %>% 
  mutate(deltaOD_Lmu_corr = deltaOD_Lmu_corr*24) %>% 
  mutate(deltaOD_Lmu_se = deltaOD_Lmu_se*24) 

```

# Adding facets labels

```{r}
MultiCultiGrowth<-MultiCultiGrowth %>% 
  mutate(Oxygen=case_when(O2==21~"250~µM",
         O2==0~"2.5~µM"))
```

```{r}
# MultiCultiGrowth<-MultiCultiGrowth %>% 
#   mutate(deltaOD_Lmu_se=case_when(deltaOD_Lmu_se>0.12~0,
#          deltaOD_Lmu_se<=0.12~deltaOD_Lmu_se)) %>% 
#   mutate(OD720_Lmu_se=case_when(OD720_Lmu_se>0.12~0,
#          OD720_Lmu_se<=0.12~OD720_Lmu_se)) 
```

```{r}
MultiCultiGrowth<-MultiCultiGrowth %>%
  mutate(deltaOD_Lmu_se=case_when(deltaOD_Lmu_corr>0~deltaOD_Lmu_se,
         deltaOD_Lmu_se<=0~0)) %>%
  mutate(OD720_Lmu_se=case_when(OD720_Lmu_corr>0~OD720_Lmu_se,
         OD720_Lmu_se<=0~0))  
  
```

```{r}
MultiCultiGrowth<-MultiCultiGrowth %>% 
  mutate(WLNum = if_else(WL == "WW", 750, as.numeric(WL))) %>%
  filter(WL != "WW") 
```

```{r}
MultiCultiGrowth %>%
  #filter(WL != "WW") %>% 
  ggplot() +
  geom_point(aes(x = WLNum, y = deltaOD_Lmu_corr,colour=as.factor(O2)), size = 3.5, alpha = 0.9, show.legend = T) +
  geom_line(aes(x = WLNum, y = deltaOD_Lmu_corr, linetype=as.factor(O2)), size = 1, alpha = 0.9, show.legend = T) +
  geom_errorbar(aes(x = WLNum, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), width=0, size=0.3, show.legend = F) +
  ggh4x::facet_nested(rows = vars(Strain)) +
  theme_bw()


MultiCultiGrowth %>%
  #filter(WL != "WW") %>% 
  ggplot() +
  geom_point(aes(x = OD720_Lmu_corr, y = deltaOD_Lmu_corr,colour=as.factor(WL)), size = 3.5, alpha = 0.9, show.legend = T) +
  geom_smooth(aes(x = OD720_Lmu_corr, y = deltaOD_Lmu_corr, linetype=as.factor(O2)), size = 1, alpha = 0.2, show.legend = T, method = "lm") +
  # geom_errorbar(aes(x = WLNum, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), width=0, size=0.3, show.legend = F) +
  ggh4x::facet_nested(rows = vars(Strain), cols = vars(O2)) +
  theme_bw()
```



-----------------------------------------------------------------------------------------------------------


# Calculated Anova and Tukey test

```{r calculated statistics}
MultiCultiGrowth2<-MultiCultiGrowth %>% 
  filter(WL != "WW")

MCGrowthRateStats<-rbind(MultiCultiGrowth2, MultiCultiGrowth2) #I created double data here

MCGrowthRateStats$O2 <- factor(MCGrowthRateStats$O2)
MCGrowthRateStats$WL <- factor(MCGrowthRateStats$WL)
MCGrowthRateStats$Strain <- factor(MCGrowthRateStats$Strain)

# Two way Anova with interactions
model<-aov(deltaOD_Lmu_corr~O2*WL*Strain, data=MCGrowthRateStats)
AnovaTest_GrowthRate<-data.frame(unclass(summary(model)), check.names = FALSE, stringsAsFactors = FALSE)
TukeyHSDTest_GrowthRate<-TukeyHSD(model, which = c("O2", "WL", "Strain"))
```



# Save RDS that create stats and tables

```{r}
saveRDS(AnovaTest_GrowthRate, file.path(TableRdsPath, paste(Project, "Anova_GrowthRate.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(TukeyHSDTest_GrowthRate, file.path(TableRdsPath, paste(Project, "HSD_GrowthRate.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Cleaning the environment

```{r}
rm(MCGrowthRateStats, model, MultiCultiGrowth2)
```

# Save Rds for further analysis

```{r save rds}
saveRDS(MultiCultiGrowth, file.path(DataOut, paste(Project, "Processed_GrowthRate.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

```


------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------



```{r set project variables}
Project <- "BalticO2"
DataIn <- file.path("..", "Data", "ImportedData", "ImportedJazEmData", fsep = .Platform$file.sep)
```

# List and read processed Olis and Jaz files

```{r exported Rmd only first time in session}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

```{r read imported pigments Exp file}
JazDataFile <- "../Data/ImportedData/ImportedJazEmData/BalticO2_Imported_JazEmData.Rds"
JazDataFileName <- str_split(string = JazDataFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
JazData <- readRDS(JazDataFile)  %>%
  ungroup()

JazData<-JazData %>% 
  select(-c(MCMeasuredPar_uE, MCSetPar_uE))
```


```{r Preliminary plot}

JazData %>%
  ggplot() +
  geom_point(aes(x = MCEm_nm, y = Emission, colour = as.factor(WL))) +
  geom_text(aes(x = EmMax_nm, y= max(Emission), label= EmMax_nm), alpha = 0.5 ,hjust = 0.5, vjust=-0.5) +
  geom_vline(aes(xintercept = EmMax_nm), linetype = "dashed") +
  scale_y_continuous(limits = c(0,100000)) +
  ggh4x::facet_nested(rows = vars(MC, WL), labeller = labeller(WL = label_both, Par = label_both, MultiCulti = label_both)) +
  theme_bw() 
```
# Normalize Jaz emission to 405 nm

```{r Normalization Jaz emission at 405}
EmissionJaz405 <- JazData %>%
  filter(WL==405) %>% 
  filter(MCEm_nm == 393) %>%
  mutate(EmJaz393 = Emission) %>%
  select(EmJaz393) 

JazDataRoundMeta405 <- JazData %>%
  filter(WL==405) %>% 
  cross_join(., EmissionJaz405) %>%
  mutate(EmNormJaz393 = Emission / EmJaz393)

rm(EmissionJaz405)
```

# Normalize Jaz emission to 450 nm

```{r Normalization Jaz emission at 450}
EmissionJaz450 <- JazData %>%
  filter(WL==450) %>% 
  filter(MCEm_nm == 441) %>%
  mutate(EmJaz441 = Emission) %>%
  select(EmJaz441)

JazDataRoundMeta450 <- JazData %>%
  filter(WL==450) %>% 
  cross_join(., EmissionJaz450) %>%
  mutate(EmNormJaz441 = Emission / EmJaz441)

rm(EmissionJaz450)
```

# Normalize Jaz emission to 470 nm

```{r Normalization Jaz emission at 470}
EmissionJaz470 <- JazData %>%
  filter(WL==470) %>% 
  filter(MCEm_nm == 469) %>%
  mutate(EmJaz469 = Emission) %>%
  select(EmJaz469) 

JazDataRoundMeta470 <- JazData %>%
  filter(WL==470) %>% 
  cross_join(., EmissionJaz470) %>%
  mutate(EmNormJaz469 = Emission / EmJaz469)

rm(EmissionJaz470)
```

# Normalize Jaz emission to 530 nm

```{r Normalization Jaz emission at 530}
EmissionJaz530 <- JazData %>%
  filter(WL==530) %>% 
  filter(MCEm_nm == 521) %>%
  mutate(EmJaz521 = Emission) %>%
  select(EmJaz521)

JazDataRoundMeta530 <- JazData %>%
  filter(WL==530) %>% 
  cross_join(., EmissionJaz530) %>%
  mutate(EmNormJaz521 = Emission / EmJaz521)

rm(EmissionJaz530)
```

# Normalize Jaz emission to 620 nm

```{r Normalization Jaz emission at 620}
EmissionJaz620 <- JazData %>%
  filter(WL==620) %>% 
  filter(MCEm_nm == 612) %>%
  mutate(EmJaz612 = Emission) %>%
  select(EmJaz612) 

JazDataRoundMeta620 <- JazData %>%
  filter(WL==620) %>% 
  cross_join(., EmissionJaz620) %>%
  mutate(EmNormJaz612 = Emission / EmJaz612)

rm(EmissionJaz620)
```

# Normalize Jaz emission to 660 nm

```{r Normalization Jaz emission at 660}
EmissionJaz660 <- JazData %>%
  filter(WL==660) %>% 
  filter(MCEm_nm == 647) %>%
  mutate(EmJaz647 = Emission) %>%
  select(EmJaz647)

JazDataRoundMeta660 <- JazData %>%
  filter(WL==660) %>% 
  cross_join(., EmissionJaz660) %>%
  mutate(EmNormJaz647 = Emission / EmJaz647)

rm(EmissionJaz660)
```

# Normalize Jaz emission to 730 nm

```{r Normalization Jaz emission at 730}
EmissionJaz730 <- JazData %>%
  filter(WL==730) %>% 
  filter(MCEm_nm == 722) %>%
  mutate(EmJaz722 = Emission) %>%
  select(EmJaz722) 

JazDataRoundMeta730 <- JazData %>%
  filter(WL==730) %>% 
  cross_join(., EmissionJaz730) %>%
  mutate(EmNormJaz722 = Emission / EmJaz722)

rm(EmissionJaz730)
```

# Normalize Jaz emission to WW

```{r Normalization Jaz emission at WW}
EmissionJazWW <- JazData %>%
  filter(WL== "WW") %>%
  filter(MCEm_nm == 600) %>%
  mutate(EmJaz600 = Emission) %>%
  select(EmJaz600) 

JazDataRoundMetaWW <- JazData %>%
  filter(WL== "WW") %>%
  cross_join(., EmissionJazWW) %>%
  mutate(EmNormJaz600 = Emission / EmJaz600)

rm(EmissionJazWW)
```
# Merge df to have all WL

```{r}
JazDataRoundMeta1 <- JazDataRoundMeta730 %>%
  full_join(., JazDataRoundMetaWW, by = c("FilenameJaz"= "FilenameJaz", "WL" = "WL", "MCEm_nm" = "MCEm_nm", "Emission" = "Emission", "MC"="MC", "EmMax_nm"="EmMax_nm", "ObsDateJaz"="ObsDateJaz"))
 
JazDataRoundMeta2 <- JazDataRoundMeta1 %>%
  full_join(., JazDataRoundMeta660, by = c("FilenameJaz"= "FilenameJaz", "WL" = "WL", "MCEm_nm" = "MCEm_nm", "Emission" = "Emission", "MC"="MC", "EmMax_nm"="EmMax_nm", "ObsDateJaz"="ObsDateJaz")) 

JazDataRoundMeta3 <- JazDataRoundMeta2 %>%
  full_join(., JazDataRoundMeta620, by = c("FilenameJaz"= "FilenameJaz", "WL" = "WL", "MCEm_nm" = "MCEm_nm", "Emission" = "Emission", "MC"="MC", "EmMax_nm"="EmMax_nm", "ObsDateJaz"="ObsDateJaz")) 

JazDataRoundMeta4 <- JazDataRoundMeta3 %>%
  full_join(., JazDataRoundMeta530, by = c("FilenameJaz"= "FilenameJaz", "WL" = "WL", "MCEm_nm" = "MCEm_nm", "Emission" = "Emission", "MC"="MC", "EmMax_nm"="EmMax_nm", "ObsDateJaz"="ObsDateJaz")) 

JazDataRoundMeta5 <- JazDataRoundMeta4 %>%
  full_join(., JazDataRoundMeta470, by = c("FilenameJaz"= "FilenameJaz", "WL" = "WL", "MCEm_nm" = "MCEm_nm", "Emission" = "Emission", "MC"="MC", "EmMax_nm"="EmMax_nm", "ObsDateJaz"="ObsDateJaz")) 

JazDataRoundMeta6 <- JazDataRoundMeta5 %>%
  full_join(., JazDataRoundMeta450, by = c("FilenameJaz"= "FilenameJaz", "WL" = "WL", "MCEm_nm" = "MCEm_nm", "Emission" = "Emission", "MC"="MC", "EmMax_nm"="EmMax_nm", "ObsDateJaz"="ObsDateJaz")) 

JazDataRoundMeta <- JazDataRoundMeta6 %>%
  full_join(., JazDataRoundMeta405, by = c("FilenameJaz"= "FilenameJaz", "WL" = "WL", "MCEm_nm" = "MCEm_nm", "Emission" = "Emission", "MC"="MC", "EmMax_nm"="EmMax_nm", "ObsDateJaz"="ObsDateJaz")) 


rm(JazDataRoundMeta1, JazDataRoundMeta2, JazDataRoundMeta3, JazDataRoundMeta4, JazDataRoundMeta5, JazDataRoundMeta6, JazDataRoundMeta405, JazDataRoundMeta450, JazDataRoundMeta470, JazDataRoundMeta530, JazDataRoundMeta620, JazDataRoundMeta660, JazDataRoundMeta730, JazDataRoundMetaWW)
```

```{r}
JazDataRoundMeta<-JazDataRoundMeta %>% 
  rename(nm=MCEm_nm) %>% 
  select(-c(MC))
```


```{r}
JazDataRoundMeta21<-JazDataRoundMeta 
  JazDataRoundMeta21$Oxygen<-"250~µM"
  
JazDataRoundMeta0<-JazDataRoundMeta 
  JazDataRoundMeta0$Oxygen<-"2.5~µM"

JazDataRoundMeta2<-rbind(JazDataRoundMeta21, JazDataRoundMeta0)
rm(JazDataRoundMeta21, JazDataRoundMeta0)
```



```{r Create plot, warning=FALSE}
lab1=c(expression("PC-rich"), expression("PE-rich"))
lab2=c(expression("2.5 µM"), expression("250 µM"))


JazDataRoundMeta2 %>%
  ggplot() +
  geom_area(aes(x = nm, y = EmNormJaz722, fill = "indianred4"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz647, fill = "brown1"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz612, fill = "coral"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz521, fill = "limegreen"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz469, fill = "lightseagreen"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz441, fill = "steelblue3"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz393, fill = "royalblue4"), alpha = 0.1, show.legend = F) +
  
  geom_point(aes(x = WLNum, y = deltaOD_Lmu_corr, colour = as.factor(Strain)), size = 4, show.legend = F, MultiCultiGrowth) +
  geom_line(aes(x = WLNum, y = deltaOD_Lmu_corr, linetype = as.factor(O2)), show.legend = T, MultiCultiGrowth) +

  geom_errorbar(aes(x = WLNum, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), width=0, size=0.3, show.legend = F, MultiCultiGrowth) +
  
  scale_colour_manual(values = c("palegreen3", "brown4"), name="", labels = lab2) +
  scale_shape_manual(values = c(16, 18), name="", labels = lab2) +
  scale_linetype_manual(values = c("solid", "dashed"), name="", labels = lab2) +
  
  stat_wl_strip(aes(x = nm), ymin = -Inf, ymax = -0.080, alpha = 0.5) +
  scale_fill_identity() +
  labs(y = "µ " ~ "("~d^-1~") and normalized emission spectra", x = "Growth waveband (nm)") +
  ggh4x::facet_nested(rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 



# g <- ggplot_gtable(ggplot_build(Plot))
# stripr <- which(grepl('strip-r', g$layout$name))
# fills <- c("palegreen3", "brown4")
# k <- 1
# for (i in stripr) {
# j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
# g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
# k <- k+1
# }
# grid.draw(g)
```

# Save plot 

```{r save plot}
#ggsave(file = file.path(FigPath, paste("Fig_GrowthRate",".png",sep = "")), height=5.5, width= 6,  dpi = 300, limitsize = TRUE)
```


-------------------------------------------------------------------------------------------

```{r set project variables}
Project <- "BalticO2"
DataIn <- file.path("..", "Data", "ProcessedData", "ProcessedOlisJazData", fsep = .Platform$file.sep)
```

# List and read processed Olis and Jaz files

```{r exported Rmd only first time in session}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

```{r read imported pigments Exp file}
OlisFile <- "../Data/ProcessedData/ProcessedOlisJazData/BalticO2_Processed_OlisSpectraTidy.Rds"
OlisFileName <- str_split(string = OlisFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
Olis <- readRDS(OlisFile)  %>%
  ungroup()

```


# Combine growth rate and Exp pigments to get PUR

```{r}
# Olis<-Olis %>% 
#     mutate(Strain=case_when(Strain=="PE-rich_127"~"PE-rich",
#          Strain=="PC-rich_077"~"PC-rich"))

MCGrowthRate <- MultiCultiGrowth %>% 
  left_join(., Olis, by = c("Run" = "Run", "SampleID" = "SampleID","Strain" = "Strain", "Par_ue" = "Par_ue", "Photoperiod" = "Photoperiod",  "O2" = "O2", "WL" = "WL", "ExpDate" = "ExpDate", "PARPhotonDose_day" = "PARPhotonDose_day", "Oxygen"="Oxygen")) 
  
```


------------------------------ Trim no growt data ------------------------------

# Filter condition where no growt

```{r}
SolFitsMetaLightCorr445590Trim1<-MCGrowthRate %>% 
  filter(Strain == "PC-rich") %>% 
  filter(O2 == 21) %>% 
  filter(WL != 405) 

SolFitsMetaLightCorr445590Trim3<-MCGrowthRate %>% 
  filter(Strain == "PC-rich") %>% 
  filter(O2 == 0) 

SolFitsMetaLightCorr445590Trim4<-MCGrowthRate %>% 
  filter(Strain == "PE-rich") %>% 
  filter(O2 == 21) %>% 
  filter(WL != 405) %>% 
  filter(WL != 450) %>% 
  filter(WL != 730) 
  
SolFitsMetaLightCorr445590Trim5<-MCGrowthRate %>% 
  filter(Strain == "PE-rich") %>% 
  filter(O2 == 0) 


MCGrowthRateTrim<-rbind(SolFitsMetaLightCorr445590Trim1, SolFitsMetaLightCorr445590Trim3, SolFitsMetaLightCorr445590Trim4, SolFitsMetaLightCorr445590Trim5)

rm(SolFitsMetaLightCorr445590Trim1, SolFitsMetaLightCorr445590Trim3, SolFitsMetaLightCorr445590Trim4, SolFitsMetaLightCorr445590Trim5)
```


```{r}
lab1=c(expression("PC-rich"), expression("PE-rich"))
lab2=c(expression("2.5 µM"), expression("250 µM"))
# lab3=c(expression("405"), expression("450"), expression("470"), expression("530"), expression("620"), expression("660"), expression("730"))


data_textD <- data.frame(Strain  = c("PC-rich"), label = c('italic(b)'))

MultiCultiGrowthPC21<-MCGrowthRateTrim %>% 
  filter(Strain == "PC-rich") %>% 
  filter(O2 == 21)
MultiCultiGrowthPE21<-MCGrowthRateTrim %>% 
  filter(Strain == "PE-rich") %>% 
    filter(O2 == 21)
  
MultiCultiGrowthPC0<-MCGrowthRateTrim %>% 
  filter(Strain == "PC-rich") %>% 
  filter(O2 == 0)
MultiCultiGrowthPE0<-MCGrowthRateTrim %>% 
  filter(Strain == "PE-rich") %>% 
    filter(O2 == 0)


GrowthPURPlot<-MCGrowthRateTrim %>%
  filter(deltaOD_Lmu_se<0.2) %>% 
  filter(deltaOD_Lmu_corr>0) %>% 
  mutate(WLNum = if_else(WL == "WW", 750, as.numeric(WL))) %>%
  filter(WL != "WW") %>%
  ggplot() +
  geom_point(aes(x = meanPUR, y = deltaOD_Lmu_corr, shape = as.factor(O2)), size = 4, show.legend = F) +
  geom_smooth(aes(x = meanPUR, y = deltaOD_Lmu_corr, linetype = as.factor(O2)), alpha = 0, size = 0.3, method = "lm", show.legend = F) +
  
    geom_point(aes(x = meanPUR, y = deltaOD_Lmu_corr), colour = "palegreen3", shape = 1, size = 4, show.legend = F, MultiCultiGrowthPC21) +
    geom_point(aes(x = meanPUR, y = deltaOD_Lmu_corr), colour = "brown4", shape = 1, size = 4, show.legend = F, MultiCultiGrowthPE21) +
    geom_point(aes(x = meanPUR, y = deltaOD_Lmu_corr), colour = "palegreen3", shape = 16, size = 4, show.legend = F, MultiCultiGrowthPC0) +
    geom_point(aes(x = meanPUR, y = deltaOD_Lmu_corr), colour = "brown4", shape = 16, size = 4, show.legend = F, MultiCultiGrowthPE0) +
  
  geom_errorbar(aes(x = meanPUR, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Strain)), width=0, size=0.3, show.legend = F) +
  geom_text(data=data_textD, aes(x=180, y=0.25, label=label), size=6, parse = TRUE) +

  scale_colour_manual(values = c("palegreen3", "brown4"), name="", labels = lab1) +
  scale_shape_manual(values = c(16, 1), name="", labels = lab2) +
  scale_linetype_manual(values = c("solid", "dashed"), name="", labels = lab2) +
  
  
  scale_x_continuous(breaks=seq(0, 180, by = 40)) +
  scale_y_continuous(breaks=seq(0, 0.3, by = 0.1)) +
  coord_cartesian(xlim = c (0, 180), ylim = c (0, 0.3)) +
  # guides(colour = FALSE) +
  #ggh4x::facet_nested(rows = vars(O2), cols = vars(Strain), labeller = label_parsed) +
  #labs(y = "µ " ~ "("~d^-1~")", x = "waveband (nm)") +
  labs(y = "µ " ~ "("~d^-1~")", x = "PUR ( µmol photons "~m^-2~""~s^-1~")") +
  ggh4x::facet_nested(rows = vars(Strain), labeller = label_parsed) +
 #ggh4x::facet_nested(cols = vars(Strain), rows = vars(factor(O2, levels=c("21","0"))), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.spacing.x = unit(0.4, 'cm'),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.key = element_blank(),
        legend.title = element_blank(),
        legend.position = c(0.10,0.99),
        legend.text = element_text(size=10))
GrowthPURPlot



```

--------------- Linear fit -------------------

```{r}
MCGrowthRateTrimlinear <- MCGrowthRateTrim %>%   
  #drop_na(Par_ue, Ex_WL, Phase, meanSig_nm2psii, AllmeanPhycoChlaRatio) %>% 
  select(c(Strain, deltaOD_Lmu_corr, meanPUR, O2, WL)) %>%  
  nest(data = -c("O2", "Strain")) %>%   
  mutate(Linear_Model = map(data, ~lm(deltaOD_Lmu_corr ~ 0 + meanPUR, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))
```

-------------------------

# Checking if slope significantly different than 0
```{r}
GrowthJVPSIIPE21<-MCGrowthRateTrim %>% 
  filter(Strain == "PE-rich") %>% 
  filter(O2 == 21)
PE21lm<-lm(deltaOD_Lmu_corr~ 0 + meanPUR, data=GrowthJVPSIIPE21)
GrowthJVPSIIPE21lm<-summary(PE21lm)
# Coefficients:
#          Estimate Std. Error t value Pr(>|t|)   
# meanPUR 0.0008797  0.0001900    4.63   0.0024 **


GrowthJVPSIIPE0<-MCGrowthRateTrim %>% 
  filter(Strain == "PE-rich") %>% 
  filter(O2 == 0)
PE0lm<-lm(deltaOD_Lmu_corr~ 0 + meanPUR, data=GrowthJVPSIIPE0)
GrowthJVPSIIPE0lm<-summary(PE0lm)
# Coefficients:
#          Estimate Std. Error t value Pr(>|t|)  
# meanPUR 0.0009282  0.0004148   2.238   0.0666 .


GrowthJVPSIIPC21<-MCGrowthRateTrim %>% 
  filter(Strain == "PC-rich") %>% 
  filter(O2 == 21)
PC21lm<-lm(deltaOD_Lmu_corr~ 0 + meanPUR, data=GrowthJVPSIIPC21)
GrowthJVPSIIPC21lm<-summary(PC21lm)
# Coefficients:
#          Estimate Std. Error t value Pr(>|t|)  
# meanPUR 0.0008525  0.0003316   2.571     0.05 *


GrowthJVPSIIPC0<-MCGrowthRateTrim %>% 
  filter(Strain == "PC-rich") %>% 
  filter(O2 == 0)
PC0lm<-lm(deltaOD_Lmu_corr~ 0 + meanPUR, data=GrowthJVPSIIPC0)
GrowthJVPSIIPC0lm<-summary(PC0lm)
# Coefficients:
#          Estimate Std. Error t value Pr(>|t|)    
# meanPUR 0.0007436  0.0001654   4.496 0.000601 ***

```




# Save plot 

```{r save plot}
#ggsave(file = file.path(FigPath, paste("SFig_GrowthRatevsPUR",".png",sep = "")), height=5.5, width= 6,  dpi = 300, limitsize = TRUE)
```


# Save Rds for further analysis

```{r save rds}
saveRDS(MCGrowthRate, file.path(DataOut, paste(Project, "Processed_GrowthRatePUR.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

```



------------------------------# Support Vector regression---------------------------------------------------

https://www.geeksforgeeks.org/support-vector-regression-svr-using-linear-and-non-linear-kernels-in-scikit-learn/

https://minimatech.org/non-linear-regression-with-r/

# Support Vector regression

```{r libraries}

# library(zoo)
# library(e1071)
# library(gcookbook)  # Load gcookbook for the uspopage data set

```

```{r}
# MCDataHourSVR <- MultiCultiGrowth 
# 
# 
# # Function to train an SVM model and make predictions
# train_and_predict_svm <- function(data) {
#   svr_model <- svm(deltaOD_Lmu_corr ~ WLNum, data = data, kernel = 'radial',
#                    cost = 5, gamma = 1)
#   data$svr_pred <- predict(svr_model, data)
#   return(data)
# }
# 
# # Group by Tube, train SVM model, and make predictions within each group
# MCDataHourSVR <- MCDataHourSVR %>%
#   group_by(Strain, O2, Oxygen) %>%
#   nest() %>%
#   mutate(data = map(data, train_and_predict_svm)) %>%
#   unnest(data) %>%
#   ungroup()
# 
# # Calculate the root mean squared error for each group
# RMSE_by_Tube <- MCDataHourSVR %>%
#   group_by(Strain, O2, Oxygen) %>%
#   summarise(RMSE = sqrt(mean((deltaOD_Lmu_corr - svr_pred)^2)))

```


```{r}
# MCDataHourSVR %>%
# 
#   ggplot() +
#   geom_point(aes(x = WLNum, y = deltaOD_Lmu_corr), alpha = 0.4) +
#   geom_line(aes(x = WLNum, y = svr_pred, color = 'SVR_radial')) +
#   geom_line(aes(x = WLNum, y = deltaOD_Lmu_corr)) +
# 
#   facet_grid(rows = vars(Strain), cols = vars (O2)) +
#   theme_bw()
```

```{r Create plot}
# lab1=c(expression("PC-rich"), expression("PE-rich"))
# lab2=c(expression("2.5 µM"), expression("250 µM"))
# 
# MultiCultiGrowthPC21<-MultiCultiGrowth %>% 
#   filter(Strain == "PC-rich") %>% 
#   filter(O2 == 21)
# MultiCultiGrowthPE21<-MultiCultiGrowth %>% 
#   filter(Strain == "PE-rich") %>% 
#     filter(O2 == 21)
#   
# MultiCultiGrowthPC0<-MultiCultiGrowth %>% 
#   filter(Strain == "PC-rich") %>% 
#   filter(O2 == 0)
# MultiCultiGrowthPE0<-MultiCultiGrowth %>% 
#   filter(Strain == "PE-rich") %>% 
#     filter(O2 == 0)
# 
# JazDataRoundMeta2 %>%
#   ggplot() +
#   geom_area(aes(x = nm, y = EmNormJaz722/10, fill = "indianred4"), alpha = 0.1, show.legend = F) +
#   geom_area(aes(x = nm, y = EmNormJaz647/10, fill = "brown1"), alpha = 0.1, show.legend = F) +
#   geom_area(aes(x = nm, y = EmNormJaz612/10, fill = "coral"), alpha = 0.1, show.legend = F) +
#   geom_area(aes(x = nm, y = EmNormJaz521/10, fill = "limegreen"), alpha = 0.1, show.legend = F) +
#   geom_area(aes(x = nm, y = EmNormJaz469/10, fill = "lightseagreen"), alpha = 0.1, show.legend = F) +
#   geom_area(aes(x = nm, y = EmNormJaz441/10, fill = "steelblue3"), alpha = 0.1, show.legend = F) +
#   geom_area(aes(x = nm, y = EmNormJaz393/10, fill = "royalblue4"), alpha = 0.1, show.legend = F) +
#   
#   geom_point(aes(x = WLNum, y = deltaOD_Lmu_corr, shape = as.factor(O2)), size = 4, show.legend = T, MultiCultiGrowth) +
#   
#     geom_point(aes(x = WLNum, y = deltaOD_Lmu_corr), colour = "palegreen3", shape = 1, size = 4, show.legend = F, MultiCultiGrowthPC21) +
#     geom_point(aes(x = WLNum, y = deltaOD_Lmu_corr), colour = "brown4", shape = 1, size = 4, show.legend = F, MultiCultiGrowthPE21) +
#     geom_point(aes(x = WLNum, y = deltaOD_Lmu_corr), colour = "palegreen3", shape = 16, size = 4, show.legend = F, MultiCultiGrowthPC0) +
#     geom_point(aes(x = WLNum, y = deltaOD_Lmu_corr), colour = "brown4", shape = 16, size = 4, show.legend = F, MultiCultiGrowthPE0) +
#   
#   #geom_line(aes(x = WLNum, y = deltaOD_Lmu_corr, linetype = as.factor(O2)), show.legend = T, MultiCultiGrowth) +
# 
#   geom_errorbar(aes(x = WLNum, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Strain)), width=0, size=0.3, show.legend = F, MultiCultiGrowth) +
#   
#   geom_line(aes(x = WLNum, y = svr_pred, linetype = as.factor(O2)), size = 0.6, show.legend = T, MCDataHourSVR) +
#   
#   scale_colour_manual(values = c("palegreen3", "brown4"), name="", labels = lab2) +
#   scale_shape_manual(values = c(16, 1), name="", labels = lab2) +
#   scale_linetype_manual(values = c("solid", "dashed"), name="", labels = lab2) +
#   
#   stat_wl_strip(aes(x = nm), ymin = -Inf, ymax = -0.09, alpha = 0.5) +
#   scale_fill_identity() +
#   labs(y = "µ " ~ "("~d^-1~") and normalized emission spectra", x = "Growth waveband (nm)") +
#   ggh4x::facet_nested(rows = vars(Strain), labeller = label_parsed) +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         panel.spacing.x = unit(0.4, 'cm'),
#         axis.text = element_text(size=12),
#         axis.text.x = element_text(size=12),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.key = element_blank(),
#         legend.title = element_blank(),
#         legend.position = c(0.10,0.90),
#         legend.text = element_text(size=10))
```

# Save plot 

```{r save plot}
#ggsave(file = file.path(FigPath, paste("Fig_GrowthRate",".png",sep = "")), height=6, width= 6,  dpi = 300, limitsize = TRUE)
```


# Plot Delta

```{r Create plot}
lab1=c(expression("PC-rich"), expression("PE-rich"))
lab2=c(expression("2.5 µM"), expression("250 µM"))


MultiCultiGrowthPC21<-MultiCultiGrowth %>% 
  filter(Strain == "PC-rich") %>% 
  filter(O2 == 21)
MultiCultiGrowthPE21<-MultiCultiGrowth %>% 
  filter(Strain == "PE-rich") %>% 
    filter(O2 == 21)
  
MultiCultiGrowthPC0<-MultiCultiGrowth %>% 
  filter(Strain == "PC-rich") %>% 
  filter(O2 == 0)
MultiCultiGrowthPE0<-MultiCultiGrowth %>% 
  filter(Strain == "PE-rich") %>% 
    filter(O2 == 0)

JazDataRoundMeta2 %>%
  ggplot() +
  geom_area(aes(x = nm, y = EmNormJaz722/10, fill = "indianred4"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz647/10, fill = "brown1"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz612/10, fill = "coral"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz521/10, fill = "limegreen"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz469/10, fill = "lightseagreen"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz441/10, fill = "steelblue3"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz393/10, fill = "royalblue4"), alpha = 0.1, show.legend = F) +
  
  geom_point(aes(x = WLNum, y = deltaOD_Lmu_corr, shape = as.factor(O2)), size = 4, show.legend = T, MultiCultiGrowth) +
  
    geom_point(aes(x = WLNum, y = deltaOD_Lmu_corr), colour = "palegreen3", shape = 1, size = 4, show.legend = F, MultiCultiGrowthPC21) +
    geom_point(aes(x = WLNum, y = deltaOD_Lmu_corr), colour = "brown4", shape = 1, size = 4, show.legend = F, MultiCultiGrowthPE21) +
    geom_point(aes(x = WLNum, y = deltaOD_Lmu_corr), colour = "palegreen3", shape = 16, size = 4, show.legend = F, MultiCultiGrowthPC0) +
    geom_point(aes(x = WLNum, y = deltaOD_Lmu_corr), colour = "brown4", shape = 16, size = 4, show.legend = F, MultiCultiGrowthPE0) +
  
  geom_line(aes(x = WLNum, y = deltaOD_Lmu_corr, linetype = as.factor(O2)), show.legend = T, MultiCultiGrowth) +

  geom_errorbar(aes(x = WLNum, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Strain)), width=0, size=0.3, show.legend = F, MultiCultiGrowth) +
    #geom_line(aes(x = WLNum, y = deltaOD_Lmu_corr, linetype = as.factor(O2)), size = 0.6, show.legend = T) +
  #geom_line(aes(x = WLNum, y = svr_pred, linetype = as.factor(O2)), size = 0.6, show.legend = T, MCDataHourSVR) +
  
  scale_colour_manual(values = c("palegreen3", "brown4"), name="", labels = lab2) +
  scale_shape_manual(values = c(16, 1), name="", labels = lab2) +
  scale_linetype_manual(values = c("solid", "dashed"), name="", labels = lab2) +
  
  stat_wl_strip(aes(x = nm), ymin = -Inf, ymax = -0.035, alpha = 0.5) +
  scale_fill_identity() +
  labs(y = "µ " ~ "("~d^-1~") and normalized emission spectra", x = "Growth waveband (nm)") +
  ggh4x::facet_nested(rows = vars(Strain), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.spacing.x = unit(0.4, 'cm'),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.key = element_blank(),
        legend.title = element_blank(),
        legend.position = c(0.10,0.90),
        legend.text = element_text(size=10))
```

# Save plot 

```{r save plot}
ggsave(file = file.path(FigPath, paste("Fig_GrowthRateDelta",".png",sep = "")), height=6, width= 6,  dpi = 300, limitsize = TRUE)
```

#Plot OD720

```{r Create plot}
lab1=c(expression("PC-rich"), expression("PE-rich"))
lab2=c(expression("2.5 µM"), expression("250 µM"))


MultiCultiGrowthPC21<-MultiCultiGrowth %>% 
  filter(Strain == "PC-rich") %>% 
  filter(O2 == 21)
MultiCultiGrowthPE21<-MultiCultiGrowth %>% 
  filter(Strain == "PE-rich") %>% 
    filter(O2 == 21)
  
MultiCultiGrowthPC0<-MultiCultiGrowth %>% 
  filter(Strain == "PC-rich") %>% 
  filter(O2 == 0)
MultiCultiGrowthPE0<-MultiCultiGrowth %>% 
  filter(Strain == "PE-rich") %>% 
    filter(O2 == 0)

JazDataRoundMeta2 %>%
  ggplot() +
  geom_area(aes(x = nm, y = EmNormJaz722/10, fill = "indianred4"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz647/10, fill = "brown1"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz612/10, fill = "coral"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz521/10, fill = "limegreen"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz469/10, fill = "lightseagreen"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz441/10, fill = "steelblue3"), alpha = 0.1, show.legend = F) +
  geom_area(aes(x = nm, y = EmNormJaz393/10, fill = "royalblue4"), alpha = 0.1, show.legend = F) +
  
  geom_point(aes(x = WLNum, y = OD720_Lmu_corr, shape = as.factor(O2)), size = 4, show.legend = T, MultiCultiGrowth) +
  
    geom_point(aes(x = WLNum, y = OD720_Lmu_corr), colour = "palegreen3", shape = 1, size = 4, show.legend = F, MultiCultiGrowthPC21) +
    geom_point(aes(x = WLNum, y = OD720_Lmu_corr), colour = "brown4", shape = 1, size = 4, show.legend = F, MultiCultiGrowthPE21) +
    geom_point(aes(x = WLNum, y = OD720_Lmu_corr), colour = "palegreen3", shape = 16, size = 4, show.legend = F, MultiCultiGrowthPC0) +
    geom_point(aes(x = WLNum, y = OD720_Lmu_corr), colour = "brown4", shape = 16, size = 4, show.legend = F, MultiCultiGrowthPE0) +
  
  geom_line(aes(x = WLNum, y = OD720_Lmu_corr, linetype = as.factor(O2)), show.legend = T, MultiCultiGrowth) +

  geom_errorbar(aes(x = WLNum, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se, colour = as.factor(Strain)), width=0, size=0.3, show.legend = F, MultiCultiGrowth) +
    #geom_line(aes(x = WLNum, y = deltaOD_Lmu_corr, linetype = as.factor(O2)), size = 0.6, show.legend = T) +
  #geom_line(aes(x = WLNum, y = svr_pred, linetype = as.factor(O2)), size = 0.6, show.legend = T, MCDataHourSVR) +
  
  scale_colour_manual(values = c("palegreen3", "brown4"), name="", labels = lab2) +
  scale_shape_manual(values = c(16, 1), name="", labels = lab2) +
  scale_linetype_manual(values = c("solid", "dashed"), name="", labels = lab2) +
  
  stat_wl_strip(aes(x = nm), ymin = -Inf, ymax = -0.055, alpha = 0.5) +
  scale_fill_identity() +
  labs(y = "µ " ~ "("~d^-1~") and normalized emission spectra", x = "Growth waveband (nm)") +
  ggh4x::facet_nested(rows = vars(Strain), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.spacing.x = unit(0.4, 'cm'),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.key = element_blank(),
        legend.title = element_blank(),
        legend.position = c(0.10,0.90),
        legend.text = element_text(size=10))
```

```{r save plot}
ggsave(file = file.path(FigPath, paste("SFig_GrowthRateOD720",".png",sep = "")), height=6, width= 6,  dpi = 300, limitsize = TRUE)
```


--------------------------------------- Growth rate vs pigments -----------------------------

```{r set project variables}
Project <- "BalticO2"
DataIn <- file.path("..", "Data", "ProcessedData", "ProcessedPigmentsData")
DataOut <- file.path("..", "Data", "ProcessedData", "ProcessedGrowthRateData", fsep = .Platform$file.sep)

FigPath <- file.path("..", "Output", "Figures")
FigRdsPath <- file.path("..", "Output", "FiguresRds")
TableRdsPath <- file.path("..", "Output", "TablesRDS")

FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```

# List and read files

```{r Exported Rmd only first time in session}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

```{r read pigments File}
#df ontained mean OD per day from Multiculti and Abs from Olis spectra for selected nm. Based on this I calculated pigments per mL and per cell (pg/cell)

MCPigmentFile <- "../Data/ProcessedData/ProcessedPigmentsData/BalticO2_Processed_Pigments.Rds"
MCPigmentFileName <- str_split(string = MCPigmentFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
MCPigment <- readRDS(MCPigmentFile)  %>%
  ungroup()
```

```{r Joining Solisense and pig data}

# colnames(MultiCultiGrowth)
# colnames(MCPigment)

MCGrowthPig <- MultiCultiGrowth %>% 
  full_join(., MCPigment, by = c("SampleID" = "SampleID", "Strain"="Strain", "Par_ue"="Par_ue", "Photoperiod"="Photoperiod", "Run"="Run", "WL"="WL", "O2"="O2", "PARPhotonDose_day"="PARPhotonDose_day", "ExpDate"="ExpDate", "LightShape"="LightShape", "Tube"="Tube", "MC"="MC")) 

```

```{r Create plot}
lab1=c(expression("PC-rich"), expression("PE-rich"))
lab2=c(expression("2.5 µM"), expression("250 µM"))

data_textb <- data.frame(Strain  = c("PC-rich"), label = c('italic(b)'))

MCGrowthPig %>%
  filter(OD720_Lmu_corr>0) %>% 
  ggplot() +
  geom_point(aes(x = meanPhycoChlaRatio, y = OD720_Lmu_corr, colour = as.factor(Strain), shape = as.factor(O2)), size = 4, show.legend = T) +
  geom_smooth(aes(x = meanPhycoChlaRatio, y = OD720_Lmu_corr, linetype = as.factor(O2)), show.legend = T, alpha = 0.2, method = "lm") +
  # geom_line(aes(x = meanPhycoChlaRatio, y = OD720_Lmu_corr, linetype = as.factor(O2)), show.legend = T) +
  geom_errorbar(aes(x = meanPhycoChlaRatio, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se, colour = as.factor(Strain)), width=0, size=0.3, show.legend = F) +
    #geom_line(aes(x = WLNum, y = deltaOD_Lmu_corr, linetype = as.factor(O2)), size = 0.6, show.legend = T) +
  #geom_line(aes(x = WLNum, y = svr_pred, linetype = as.factor(O2)), size = 0.6, show.legend = T, MCDataHourSVR) +
  scale_colour_manual(values = c("palegreen3", "brown4"), name="", labels = lab2) +
  scale_shape_manual(values = c(16, 1), name="", labels = lab2) +
  scale_linetype_manual(values = c("solid", "dashed"), name="", labels = lab2) +
  #labs(y = "µ " ~ "("~d^-1~") and normalized emission spectra", x = "Growth waveband (nm)") +
  ggh4x::facet_nested(rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 


MCGrowthPig %>%
  filter(deltaOD_Lmu_corr>0) %>% 
  ggplot() +
  geom_point(aes(x = meanPhycoChlaRatio, y = deltaOD_Lmu_corr, colour = as.factor(Strain), shape = as.factor(O2)), size = 4, show.legend = F) +
  geom_smooth(aes(x = meanPhycoChlaRatio, y = deltaOD_Lmu_corr, linetype = as.factor(O2)), show.legend = F, alpha = 0.2, method = "lm") +
  # geom_line(aes(x = meanPhycoChlaRatio, y = deltaOD_Lmu_corr, linetype = as.factor(O2)), show.legend = T) +
  geom_errorbar(aes(x = meanPhycoChlaRatio, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Strain)), width=0, size=0.3, show.legend = F) +
    #geom_line(aes(x = WLNum, y = deltaOD_Lmu_corr, linetype = as.factor(O2)), size = 0.6, show.legend = T) +
  #geom_line(aes(x = WLNum, y = svr_pred, linetype = as.factor(O2)), size = 0.6, show.legend = T, MCDataHourSVR) +
  geom_text(data=data_textb, aes(x=6, y=0.15, label=label), size=6, parse = TRUE) +
  
  scale_colour_manual(values = c("palegreen3", "brown4"), name="", labels = lab2) +
  scale_shape_manual(values = c(16, 1), name="", labels = lab2) +
  scale_linetype_manual(values = c("solid", "dashed"), name="", labels = lab2) +
  
  scale_y_continuous(breaks=seq(-0.5, 0.2, by = 0.1)) +
  coord_cartesian(ylim = c(-0.05, 0.2)) +
  
  #labs(y = "µ " ~ "("~d^-1~") and normalized emission spectra", x = "Growth waveband (nm)") +
  labs(y = "µ " ~ "("~d^-1~")", x = "Phycobiliprotein to Chl" ~italic(a)~ "ratio (µg:µg)") +
  ggh4x::facet_nested(rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 

```

------------------------------------ Linear regression ---------------------------------

```{r}
SolFitsAllPigmentfitPhycoChlalinear <- MCGrowthPig %>%   
  #drop_na(Par_ue, Ex_WL, Phase, meanSig_nm2psii, AllmeanPhycoChlaRatio) %>% 
  select(c(Strain, Par_ue, Photoperiod, deltaOD_Lmu_corr, meanPhycoChlaRatio, O2, WL, WLNum)) %>%  
  nest(data = -c("O2", "Strain")) %>%   
  mutate(Linear_Model = map(data, ~lm(deltaOD_Lmu_corr ~ meanPhycoChlaRatio, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))
```

```{r}
MCGrowthPig %>% 
  ggplot() +
  geom_point(aes(y = deltaOD_Lmu_corr, x = PhycoChlaRatio, colour=as.factor(Strain)), size = 3.5, show.legend = T) +
  geom_smooth(aes(y = deltaOD_Lmu_corr, x = PhycoChlaRatio, linetype=as.factor(O2)), size = 1, show.legend = T, method = "lm") +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "Total phycobilins/Chl" ~italic(a)~ "ratio") +
  ggh4x::facet_nested(rows = vars(Strain, O2), labeller = label_parsed) +
  theme_bw() 



SolFitsAllPigmentfitPhycoChlalinear %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(y = deltaOD_Lmu_corr, x = meanPhycoChlaRatio, colour=as.factor(Strain)), size = 3.5, show.legend = T, MCGrowthPig) + 

  geom_line(aes(x = meanPhycoChlaRatio, y = `.fitted`), show.legend = F) +   
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "Total phycobilins/Chl" ~italic(a)~ "ratio") +
  ggh4x::facet_nested(rows = vars(Strain, O2), labeller = label_parsed) +
  theme_bw() 
```
t-test from the linear model Phase
```{r}
# Strain across O2
Stats77_ExpSt<-MCGrowthPig %>%
  filter(Strain == "PC-rich") 
  fit <- lm(deltaOD_Lmu_corr ~ PhycoChlaRatio + O2 + PhycoChlaRatio:O2,data=Stats77_ExpSt)
x <- cbind(t(as.numeric(coefficients(fit))), t(as.numeric(summary(fit)$coefficients[4, 4])), t(as.numeric(summary(fit)$coefficients[4, 3])), t(as.numeric(summary(fit)$coefficients[4, 2])))
model_77021<-data.frame(unclass(x), check.names = FALSE, stringsAsFactors = FALSE) %>% 
  rename("Estimate" = "4", "Std.Error" = "7", "t_value" = "6", "p_value" = "5") %>% 
  select(c("Estimate", "Std.Error", "t_value", "p_value"))
  model_77021$FitComparison <- 'PC-rich_0:21'


Stats127_ExpSt<-MCGrowthPig %>%
  filter(Strain == "PE-rich") 
  fit <- lm(deltaOD_Lmu_corr ~ PhycoChlaRatio + O2 + PhycoChlaRatio:O2,data=Stats127_ExpSt)
x <- cbind(t(as.numeric(coefficients(fit))), t(as.numeric(summary(fit)$coefficients[4, 4])), t(as.numeric(summary(fit)$coefficients[4, 3])), t(as.numeric(summary(fit)$coefficients[4, 2])))
model_127021<-data.frame(unclass(x), check.names = FALSE, stringsAsFactors = FALSE) %>% 
  rename("Estimate" = "4", "Std.Error" = "7", "t_value" = "6", "p_value" = "5") %>% 
  select(c("Estimate", "Std.Error", "t_value", "p_value"))
  model_127021$FitComparison <- 'PE-rich_0:21'

modelO2<-rbind(model_77021, model_127021)
  rm(model_77021, model_127021)
  
  

# O2 across Strain
Stats77_ExpSt<-MCGrowthPig %>%
  filter(O2 == 0) 
  fit <- lm(deltaOD_Lmu_corr ~ PhycoChlaRatio + Strain + PhycoChlaRatio:Strain,data=Stats77_ExpSt)
x <- cbind(t(as.numeric(coefficients(fit))), t(as.numeric(summary(fit)$coefficients[4, 4])), t(as.numeric(summary(fit)$coefficients[4, 3])), t(as.numeric(summary(fit)$coefficients[4, 2])))
model_077127<-data.frame(unclass(x), check.names = FALSE, stringsAsFactors = FALSE) %>% 
  rename("Estimate" = "4", "Std.Error" = "7", "t_value" = "6", "p_value" = "5") %>% 
  select(c("Estimate", "Std.Error", "t_value", "p_value"))
  model_077127$FitComparison <- '0_PC-rich:PE-rich'


Stats127_ExpSt<-MCGrowthPig %>%
  filter(O2 == 21) 
  fit <- lm(deltaOD_Lmu_corr ~ PhycoChlaRatio + Strain + PhycoChlaRatio:Strain,data=Stats127_ExpSt)
x <- cbind(t(as.numeric(coefficients(fit))), t(as.numeric(summary(fit)$coefficients[4, 4])), t(as.numeric(summary(fit)$coefficients[4, 3])), t(as.numeric(summary(fit)$coefficients[4, 2])))
model_2177127<-data.frame(unclass(x), check.names = FALSE, stringsAsFactors = FALSE) %>% 
  rename("Estimate" = "4", "Std.Error" = "7", "t_value" = "6", "p_value" = "5") %>% 
  select(c("Estimate", "Std.Error", "t_value", "p_value"))
  model_2177127$FitComparison <- '21_PC-rich:PE-rich'

modelStrain<-rbind(model_077127, model_2177127)
  rm(model_077127, model_2177127)
  
```


# Merge statistic
```{r}
Anova_GrowthPigRatio<-rbind(modelO2, modelStrain)
rm(modelO2, modelStrain)
```


# Save RDS that create stats and tables

```{r}
saveRDS(Anova_GrowthPigRatio, file.path(TableRdsPath, paste(Project, "Anova_GrowthPigRatio_Model.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```


```{r Create plot}
lab1=c(expression("PC-rich"), expression("PE-rich"))
lab2=c(expression("2.5 µM"), expression("250 µM"))

data_textb <- data.frame(Strain  = c("PC-rich"), label = c('italic(b)'))

data_text_PC1<- data.frame(Strain  = c("PC-rich"), label = c('aC'))
data_text_PC2<- data.frame(Strain  = c("PC-rich"), label = c('aA'))
data_text_PE1<- data.frame(Strain  = c("PE-rich"), label = c('bB'))
data_text_PE2<- data.frame(Strain  = c("PE-rich"), label = c('cD'))

data_text_Anova<- data.frame(Strain  = c("PE-rich"),  label = c(' , \u03B1 = 0.05'))
data_text_Anova2<- data.frame(Strain  = c("PE-rich"),  label = c('italic(t)~-test'))

FigGrowthPig<-MCGrowthPig %>%
  filter(deltaOD_Lmu_corr>0) %>% 
  ggplot() +
  geom_point(aes(x = meanPhycoChlaRatio, y = deltaOD_Lmu_corr, colour = as.factor(Strain), shape = as.factor(O2)), size = 4, show.legend = F) +
  #geom_point(aes(x = PhycoChlaRatio, y = deltaOD_Lmu_corr, colour = as.factor(Strain), shape = as.factor(O2)), size = 1, alpha = 0.5, show.legend = F) +
  geom_smooth(aes(x = meanPhycoChlaRatio, y = deltaOD_Lmu_corr, linetype = as.factor(O2)), size = 0.3, colour = "blue", show.legend = F, alpha = 0, method = "lm") +
  # geom_line(aes(x = meanPhycoChlaRatio, y = deltaOD_Lmu_corr, linetype = as.factor(O2)), show.legend = T) +
  geom_errorbar(aes(x = meanPhycoChlaRatio, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Strain)), width=0, size=0.3, show.legend = F) +
    #geom_line(aes(x = WLNum, y = deltaOD_Lmu_corr, linetype = as.factor(O2)), size = 0.6, show.legend = T) +
  #geom_line(aes(x = WLNum, y = svr_pred, linetype = as.factor(O2)), size = 0.6, show.legend = T, MCDataHourSVR) +
  geom_text(data=data_textb, aes(x=6, y=0.15, label=label), size=6, parse = TRUE) +
  
  scale_colour_manual(values = c("palegreen3", "brown4"), name="", labels = lab2) +
  scale_shape_manual(values = c(16, 1), name="", labels = lab2) +
  scale_linetype_manual(values = c("solid", "dashed"), name="", labels = lab2) +
  
  scale_y_continuous(breaks=seq(-0.5, 0.2, by = 0.1)) +
  coord_cartesian(ylim = c(-0.05, 0.2)) +
  
  geom_text(data=data_text_PC1, aes(x=3.4, y=0.15, label=label), colour = "blue", size=5) +
  geom_text(data=data_text_PC2, aes(x=3.9, y=0.18, label=label), colour = "blue", size=5) +
  geom_text(data=data_text_PE1, aes(x=3.5, y=0.14, label=label), colour = "blue", size=5) +
  geom_text(data=data_text_PE2, aes(x=5.5, y=0.16, label=label), colour = "blue", size=5) +
  
  geom_text(data=data_text_Anova, aes(x=5.5, y=0, label=label), colour = "blue", size=5) +
  geom_text(data=data_text_Anova2, aes(x=4.7, y=0, label=label), colour = "blue", size=5, parse = TRUE) +
  #labs(y = "µ " ~ "("~d^-1~") and normalized emission spectra", x = "Growth waveband (nm)") +
  labs(y = "µ " ~ "("~d^-1~")", x = "Phycobiliproteins to Chl" ~italic(a)~ "ratio (µg:µg)") +
  ggh4x::facet_nested(rows = vars(Strain), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.spacing.x = unit(0.4, 'cm'),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.key = element_blank(),
        legend.title = element_blank(),
        legend.position = c(0.10,0.90),
        legend.text = element_text(size=10))
FigGrowthPig
```


# Save Rds for further analysis

```{r save rds}
# saveRDS(MCGrowthPig, file.path(DataOut, paste(Project, "Processed_GrowthRatePigmentsCombine.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

```





